name: Copy and tag image directly from GHCR to Registry
description: Copy the image directly from GHCR to Registry without pulling to local disk

inputs:
  image:
    description: Image name
    required: true
  platform:
    description: Image platform
    required: true
  variant:
    description: Variant tag prefix
    required: true

runs:
  using: composite
  steps:
    - name: Download tags file ğŸ“¥
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: ${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}-tags
        path: /tmp/jupyter/tags/

    - name: Install Crane
      uses: imjasonh/setup-crane@v0.5

    - name: Copy and tag image directly from GHCR to Registry ğŸ·
      run: |
        SOURCE_REGISTRY=ghcr.io \
        SOURCE_OWNER=${{ github.repository_owner }} \
        SOURCE_IMAGE_TAG=build-${{ github.sha }}-${{ github.run_id }}-${{ inputs.platform }}-${{ inputs.variant }} \
        python3 -m tagging.apps.copy_and_tag_image \
          --registry ${{ env.REGISTRY }} \
          --owner ${{ env.OWNER }} \
          --image ${{ inputs.image }} \
          --variant ${{ inputs.variant }} \
          --platform ${{ inputs.platform }} \
          --tags-dir /tmp/jupyter/tags/
      shell: bash

    - name: Install Syft ğŸ“¦
      uses: anchore/sbom-action/download-syft@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
      id: syft

    - name: Generate SBOM for the image ğŸ§¾
      run: |
        syft \
          --from oci-registry \
          --platform linux/${{ inputs.platform == 'aarch64' && 'arm64' || 'amd64' }} \
          -o spdx-json=/tmp/sbom-${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}.spdx.json \
          ghcr.io/${{ github.repository_owner }}/sequencing-docker-stacks/${{ inputs.image }}:build-${{ github.sha }}-${{ github.run_id }}-${{ inputs.platform }}-${{ inputs.variant }}
      shell: bash

    - name: Upload SBOM artifact ğŸ“¤
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: ${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}-sbom.spdx.json
        path: /tmp/sbom-${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}.spdx.json
        retention-days: 40

    - name: Logout from GHCR ğŸ”
      if: always()
      run: |
        docker logout ghcr.io
      shell: bash
