name: Apptainer Debug - Test Installation and Login

env:
  REGISTRY: quay.io
  OWNER: ${{ github.repository_owner }}

on:
  workflow_dispatch:
    inputs:
      test_description:
        description: 'Description of what you are testing'
        required: false
        type: string
        default: 'Testing apptainer installation and registry login'

permissions:
  contents: read

jobs:
  apptainer-debug:
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - name: Checkout Repo ‚ö°Ô∏è
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Show test description
        run: |
          echo "Test Description: ${{ inputs.test_description }}"
        shell: bash

      - name: Show environment info
        run: |
          echo "=== Environment Information ==="
          echo "User: $(whoami)"
          echo "Home directory: $HOME"
          echo "Working directory: $(pwd)"
          echo "Disk usage:"
          df -h
          echo ""
          echo "=== Checking .apptainer directory ==="
          ls -la $HOME/.apptainer || echo "Directory does not exist yet"
        shell: bash

      - name: Install Apptainer üîß
        run: |
          # Install dependencies
          sudo apt-get update -y
          sudo apt-get install -y \
            software-properties-common \
            wget

          # Add Apptainer repository and install
          sudo add-apt-repository -y ppa:apptainer/ppa
          sudo apt-get update -y
          sudo apt-get install -y apptainer

          # Verify installation
          apptainer --version
        shell: bash

      - name: Check Apptainer configuration
        run: |
          echo "=== Checking Apptainer configuration ==="
          echo "Apptainer version:"
          apptainer --version
          echo ""
          echo "Apptainer config:"
          apptainer config global || echo "Failed to get global config"
          echo ""
          echo "Checking .apptainer directory after installation:"
          ls -la $HOME/.apptainer || echo "Directory still does not exist"
          echo ""
          echo "Checking permissions on home directory:"
          ls -ld $HOME
        shell: bash

      - name: Login to Registry üîê
        run: |
          echo "$REGISTRY_TOKEN" | apptainer registry login -u "$REGISTRY_USERNAME" --password-stdin oras://${{ env.REGISTRY }}
        shell: bash
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
        id: login

      - name: Verify login
        run: |
          echo "Login successful!"
          echo "Checking remote configuration:"
          cat $HOME/.apptainer/remote.yaml || echo "Cannot read remote.yaml"
        shell: bash

      - name: Logout from Registry üîê
        if: always() && steps.login.outcome == 'success'
        run: |
          apptainer remote logout oras://${{ env.REGISTRY }}
        shell: bash
