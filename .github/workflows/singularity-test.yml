name: Test using the images with Singularity

env:
  REGISTRY: quay.io
  OWNER: ${{ github.repository_owner }}

on:
  workflow_call:
    inputs:
      image:
        description: Image name
        required: true
        type: string
      timeout-minutes:
        description: Timeout in minutes
        required: false
        default: 20
        type: number
      platform:
        description: Image platform
        required: false
        type: string
        default: x86_64
      runs-on:
        description: GitHub Actions Runner image
        required: false
        type: string
        default: ubuntu-24.04
      variant:
        description: Variant tag prefix
        required: false
        type: string
        default: default

jobs:
  singularity-test:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: ${{ inputs.timeout-minutes }}

    steps:
      - name: Free disk space ğŸ§¹
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install zstd ğŸ§©
        run: |
          apk update && \
          apk add --no-cache zstd

      - name: Checkout Repo âš¡ï¸
        uses: actions/checkout@v4

      - name: Download built image ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}
          path: /tmp/jupyter/images/

      - name: Uncompress downloaded image ğŸ“¥
        run: |
          unzstd /tmp/jupyter/images/${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}.tar.zst

      - name: Test Singularity image ğŸ§ª
        run: >
          docker run --rm
              -v /tmp/jupyter/images:/tmp/jupyter/images
              --entrypoint /bin/bash
              --platform ${{ inputs.platform }}
              docker-archive:/tmp/jupyter/images/${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}.tar
              -c "singularity exec --writable-tmpfs
                /tmp/jupyter/images/${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}.tar
                pip install --target=/opt/conda natsort"
